# Задача
Создать 4 таблицы на postgresql: продукты, категории, статистика, заказы, и заполнить стандартными столбцами на ваш выбор. В таблице Заказы добавить колонку с временем покупки. Вам необходимо написать триггер на таблицу с заказами: при добавлении новой строки в таблицу с заказами, собирать статистику сколько товаров и какой категории было куплено за день.

## Общая информация
Проект представляет собой докер-контейнер, содержащий СУБД PostgreSql, а так-же средство администрирования PgAdmin. Ключевым содержимым является файл ```bkp```, являющийся резервной копией бд со встроенным триггером, выполняющим вышеописанную задачу.
Триггер можно проверить как в собственном рабочем окружении, просто импортировав файл в свою бд, либо запустить рабочее окружение докера и проверить работу там.

Здесь будет рассмотрен 2-ой вариант. 

## 0. Подготовка

Находясь в папке, в которую Вы хотите скачать проект, клонируем репозиторий с помощью команды:

```git clone git@github.com:Longin89/Pg-trigger.git```

После этого, переходим в папку проекта:

```cd Pg-trigger-main```

## 1. Установка

Скачиваем, конфигурируем и запускаем контейнер командой:

```docker-compose up -d```

## 2. Вход в PgAdmin

В браузерной строке переходим по адресу:

```http://localhost:8080```

и видим экран входа в админку:

![enter](/screenshots/1.jpg)

#### Если вместо админки Вы видите надпись ```Forbidden``` - дайте полные права на папку проекта и перезагрузите страницу. Если страница просто не открывается, подождите ~15 секунд и перезагрузите страницу - контейнеру нужно некоторое время для запуска всех служб.

Логин: ```test@gmail.com```

Пароль: ```root```

После входа в админку Вам нужно подключиться к локальному серверу, введя пароль: ```pass```

![local](/screenshots/2.jpg)

Введя пароль от сервера, Вы увидите рабочий экран PgAdmin:

![pgadmin](/screenshots/3.jpg)

## 3. Импорт базы данных

Нажмите правой кнопкой мыши на бд ```newbase``` -> ```Restore...```

![restore](/screenshots/4.jpg)

В открывшемся окне нажмите на значок папки, далее на значок ```...``` -> ```Upload```

![upload](/screenshots/5.jpg)

В открывшемся окне нажимаем на любую область и выбираем файл ```bkp``` для загрузки.

![select](/screenshots/6.jpg)

После загрузки файла закройте окошко, нажав на верхний крестик, выделите файл ```bkp``` и нажмите кнопку ```Select``` , затем ```Restore```.

После успешного импорта Вы увидите соответствующее сообщение:

![restored](/screenshots/7.jpg)

Импортированные таблицы появятся в панели администрирования:

![tables](/screenshots/8.jpg)

где:

```categories``` - включает в себя ид и наименование категории.

```groceries``` - включает в себя ид, наименование и цену продукта.

```orders``` - включает в себя ид заказа, категории, продукта, а так-же количество заказанного продукта и время заказа.

```stats``` - включает в себя ид, дату, количество заказанных продуктов и их категорию.

## 4. Добавление записи и проверка работы триггера
Нажмите на пункте ```Tables``` правой кнопкой -> ```Query Tool```, чтобы открыть экран ввода запросов.

![querytool](/screenshots/9.jpg)

Для добавления записи в заказы можно использовать условную запись вида:

```INSERT INTO ORDERS(grocery_id, quantity, category_id, order_time)```

```VALUES```
```(1, 11, 1, NOW()::TIMESTAMP AT TIME ZONE 'UTC +03');```

Что добавит в таблицу ```orders``` заказ, содержащий продукт с ид = 1, в количестве 11 штук из 1 категории товаров и временной меткой, указывающей на время создания заказа по московскому времени.

Убедиться, что триггер отработал можно, введя запрос вида:

```SELECT date, category_id, SUM(grocery_qty)```

```AS total_grocery_qty```

```FROM stats```

```GROUP BY date, category_id```

```ORDER by date;```

и получив результат вида:

![queryresult](/screenshots/10.jpg)

с указанием даты, категории и количества заказанных продуктов.